---
layout: article
title:  "mycat 安装和使用"
tags: mycat
categories: 拓展
date: 2017-05-02 10:34:00
---
<div id='preview-contents' class='note-content'>
                        
                    



<h3 id="mycat-安装和使用">mycat 安装和使用</h3>

<ul><li><strong>mycat 安装</strong></li>
</ul>

<table>
<thead>
<tr>
  <th align="center">主机名</th>
  <th align="center">IP</th>
  <th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
  <td align="center">pz-centos-128</td>
  <td align="center">192.168.237.128</td>
  <td align="center">MyCat、MySQL</td>
</tr>
<tr>
  <td align="center">pz-ubuntu-130</td>
  <td align="center">192.168.237.130</td>
  <td align="center">MySQL</td>
</tr>
</tbody></table>




<pre class="prettyprint hljs-dark"><code class="language-bash hljs">[pz-centos-128<span class="hljs-comment">#] wget http://dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz</span><br>[pz-centos-128<span class="hljs-comment">#]  tar -zxv -C /usr/local -f Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz</span><br>[pz-centos-128<span class="hljs-comment">#]  cd /usr/local/mycat/</span><br></code></pre>

<ul><li><strong>配置mycat</strong> <br>
-读取 pz-ubuntu-130 下的mycat_lms下的lms_message、lms_message_recored、lms_message_send这三个表，其余的表读zt_lms库,修改schema.xml如下：</li>
</ul>



<pre class="prettyprint hljs-dark"><code class="language-xml hljs"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span><br><span class="hljs-meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:schema</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">"http://io.mycat/"</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"zt_lms"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_message"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"message_id"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"message_shared"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_message_recored"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"message_shared"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_message_send"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"ms_id"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"message_shared"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message_shared"</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">database</span>=<span class="hljs-string">"mycat_lms"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"zt_lms"</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">database</span>=<span class="hljs-string">"zt_lms"</span> /&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">"1000"</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">writeType</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">"mysql"</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">"native"</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">"100"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">"hostM1"</span> <span class="hljs-attr">url</span>=<span class="hljs-string">"192.168.237.130:3307"</span> <span class="hljs-attr">user</span>=<span class="hljs-string">"root"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"qwer1111"</span> /&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:schema</span>&gt;</span><br></code></pre>

<ul><li><strong>修改server.xml</strong></li>
</ul>



<pre class="prettyprint hljs-dark"><code class="language-xml hljs">[root@pz-centos-128 mycat]# vim conf/server.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"root"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span>123456<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"schemas"</span>&gt;</span>message<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"schemas"</span>&gt;</span>message<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"readOnly"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre>

<ul><li><strong>安装jdk</strong></li>
</ul>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">[root@pz-centos-128 src]  wget http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.tar.gz<br>[root@pz-centos-128 src]<span class="hljs-comment">#  tar zxvf jdk-8u101-linux-x64.tar.gz -C /usr/local</span><br>[root@pz-centos-128 src]<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_101<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>[root@pz-centos-128 src]<span class="hljs-comment"># source /etc/profile</span><br></code></pre>

<ul><li><strong>启动mycat</strong></li>
</ul>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">[root@pz-centos-128 mycat]<span class="hljs-comment"># bin/mycat console</span><br></code></pre>

<p>连接8066（9066是管理接口，可通过9066端口查看mycat的datanode等信息，也可通过该端口重新加载配置文件）。</p>



<pre class="prettyprint hljs-dark"><code class="language-sql hljs">[root@pz-centos-128 pengzhen]# mysql -uroot -p123456 -P8066 -h127.0.0.1<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br>Welcome to the MySQL monitor. Commands <span class="hljs-keyword">end</span> <span class="hljs-keyword">with</span> ; or \g.<br>Your MySQL connection id is 1<br>Server version: 5.6.29-mycat-1.6-<span class="hljs-keyword">RELEASE</span><span class="hljs-number">-20161028204710</span> MyCat <span class="hljs-keyword">Server</span> (OpenCloundDB)<br><br>Copyright (c) <span class="hljs-number">2000</span>, <span class="hljs-number">2016</span>, <span class="hljs-keyword">Oracle</span> <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> its affiliates. All rights reserved.<br><br><span class="hljs-keyword">Oracle</span> <span class="hljs-keyword">is</span> a registered trademark <span class="hljs-keyword">of</span> <span class="hljs-keyword">Oracle</span> Corporation <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> its<br>affiliates. Other <span class="hljs-keyword">names</span> may be trademarks <span class="hljs-keyword">of</span> their respective<br>owners.<br><br><span class="hljs-keyword">Type</span> <span class="hljs-string">'help;'</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'\h'</span> <span class="hljs-keyword">for</span> help. <span class="hljs-keyword">Type</span> <span class="hljs-string">'\c'</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">clear</span> the <span class="hljs-keyword">current</span> <span class="hljs-keyword">input</span> statement.<br><br>mysql&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">databases</span>;<br>+<span class="hljs-comment">----------+</span><br>| DATABASE |<br>+<span class="hljs-comment">----------+</span><br>| message |<br>+<span class="hljs-comment">----------+</span><br>1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql&gt; <span class="hljs-keyword">use</span> message;<br>Reading table information for completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br>mysql&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">tables</span>;<br>...<br>...<br>| lms_weixin_reply |<br>| lms_weixin_reply_base |<br>| lms_wish |<br>| lms_zol |<br>| lms_zol_good |<br>| lms_zol_reply |<br>+<span class="hljs-comment">----------------------------------+</span><br>174 rows in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> lms_message_send <span class="hljs-keyword">where</span> ms_id=<span class="hljs-number">5</span>;<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| ms_id | message_id | type | from_user_id | to_user_id | filter_exp | status |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| 5 | 2 | 3 | 0 | 10655 | 0 | 1 |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br><br>修改mycat_lms中message_send表的数据，在 pz-ubuntu-130 mysql中<br><br>mysql&gt; <span class="hljs-keyword">update</span> mycat_lms.lms_message_send <span class="hljs-keyword">set</span> <span class="hljs-keyword">status</span>=<span class="hljs-number">0</span> <span class="hljs-keyword">where</span> ms_id =<span class="hljs-number">5</span>;<br>mysql&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> zt_lms.lms_message_send <span class="hljs-keyword">where</span> ms_id=<span class="hljs-number">5</span>;<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| ms_id | message_id | type | from_user_id | to_user_id | filter_exp | status |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| 5 | 2 | 3 | 0 | 10655 | 0 | 1 |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> mycat_lms.lms_message_send <span class="hljs-keyword">where</span> ms_id=<span class="hljs-number">5</span>;<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| ms_id | message_id | type | from_user_id | to_user_id | filter_exp | status |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| 5 | 2 | 3 | 0 | 10655 | 0 | 0 |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br></code></pre>

<p>然后在通过mycat端查询：</p>



<pre class="prettyprint hljs-dark"><code class="language-sql hljs">mysql&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> lms_message_send <span class="hljs-keyword">where</span> ms_id=<span class="hljs-number">5</span>;<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| ms_id | message_id | type | from_user_id | to_user_id | filter_exp | status |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br>| 5 | 2 | 3 | 0 | 10655 | 0 | 0 |<br>+<span class="hljs-comment">-------+------------+------+--------------+------------+------------+--------+</span><br></code></pre>

<p>以上测试，确定我们定义的三个表确实是指向的mycat_lms库，而其他表则为zt_lms库。</p>

<ul><li><strong><em>对lms_message_send水平分表</em></strong></li>
</ul>



<pre class="prettyprint hljs-dark"><code class="language-xml hljs">schema.xml<br><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_message_send"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"ms_id"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"message_shared"</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">"to_user_id_long_partition"</span> <span class="hljs-attr">subTables</span>=<span class="hljs-string">"lms_message_send_1,lms_message_send_2,lms_message _send_3"</span> /&gt;</span><br><br>rule.xml<br>//固定哈希分片<br><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span><br><span class="hljs-meta">&lt;!DOCTYPE mycat:rule SYSTEM "rule.dtd"&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:rule</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">"http://io.mycat/"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">tableRule</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"to_user_id_long_partition"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">rule</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">columns</span>&gt;</span>to_user_id<span class="hljs-tag">&lt;/<span class="hljs-name">columns</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">algorithm</span>&gt;</span>func1<span class="hljs-tag">&lt;/<span class="hljs-name">algorithm</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">tableRule</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">function</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"func1"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"io.mycat.route.function.PartitionByLong"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"partitionCount"</span>&gt;</span>2,1<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"partitionLength"</span>&gt;</span>256,512<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">function</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:rule</span>&gt;</span><br></code></pre>

<p>连接8066后，先explain：</p>



<pre class="prettyprint hljs-dark"><code class="language-sql hljs">mysql&gt; <span class="hljs-keyword">explain</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`lms_message_send`</span> (<span class="hljs-string">`ms_id`</span>, <span class="hljs-string">`message_id`</span>, <span class="hljs-string">`type`</span>, <span class="hljs-string">`from_user_id`</span>, <span class="hljs-string">`to_user_id`</span>, <span class="hljs-string">`filter_exp`</span>, <span class="hljs-string">`status`</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10655</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br>+<span class="hljs-comment">----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br>| DATA_NODE | SQL |<br>+<span class="hljs-comment">----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br>| message_shared | <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> lms_message_send_2 (<span class="hljs-string">`ms_id`</span>, <span class="hljs-string">`message_id`</span>, <span class="hljs-string">`type`</span>, <span class="hljs-string">`from_user_id`</span>, <span class="hljs-string">`to_user_id`</span> , <span class="hljs-string">`filter_exp`</span>, <span class="hljs-string">`status`</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10655</span> , <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) |<br>+<span class="hljs-comment">----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)<br></code></pre>

<p>经测试，分表不能执行批量插入的sql。</p>

<ul><li><strong><em>分库分表</em></strong> <br>
之前是在同一个库中分表，现在改用多个node来分表</li>
</ul>

<pre class="prettyprint hljs-dark"><code class="language-xml hljs"> schema.xml，多库分表<br><span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">"100"</span> &gt;</span><br><span class="hljs-comment">&lt;!--<br>&lt;table name="lms_message_content" primaryKey="message_id" dataNode="message_shared" /&gt;<br>&lt;table name="lms_message_recored" primaryKey="user_id" dataNode="message_shared" /&gt;<br><br>&lt;table name="lms_message_send" primaryKey="ms_id" dataNode="message_shared" rule="to_user_id_long_partition" subTables="lms_message_send_1,lms_message_send_2,lms_message_send_3" /&gt;<br><br>--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_message_send"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"ms_id"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"message_shared,message_tmp"</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">"to_user_id_long_partition"</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message_shared"</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">database</span>=<span class="hljs-string">"mycat_lms"</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message_tmp"</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">database</span>=<span class="hljs-string">"tmp"</span> /&gt;</span><br></code></pre>

<pre class="prettyprint hljs-dark"><code class="language-sql hljs"> mysql&gt; <span class="hljs-keyword">explain</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`lms_message_send`</span> (<span class="hljs-string">`ms_id`</span>, <span class="hljs-string">`message_id`</span>, <span class="hljs-string">`type`</span>, <span class="hljs-string">`from_user_id`</span>, <span class="hljs-string">`to_user_id`</span>, <span class="hljs-string">`filter_exp`</span>, <span class="hljs-string">`status`</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-literal">NULL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1062</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>),(<span class="hljs-literal">NULL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10655</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br>+<span class="hljs-comment">----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br>| DATA_NODE | SQL |<br>+<span class="hljs-comment">----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br>| message_shared | <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`lms_message_send`</span> (<span class="hljs-string">`ms_id`</span>, <span class="hljs-string">`message_id`</span>, <span class="hljs-string">`type`</span>, <span class="hljs-string">`from_user_id`</span>, <span class="hljs-string">`to_user_id`</span> , <span class="hljs-string">`filter_exp`</span>, <span class="hljs-string">`status`</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1062</span> , <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) |<br>| message_tmp | <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`lms_message_send`</span> (<span class="hljs-string">`ms_id`</span>, <span class="hljs-string">`message_id`</span>, <span class="hljs-string">`type`</span>, <span class="hljs-string">`from_user_id`</span>, <span class="hljs-string">`to_user_id`</span> , <span class="hljs-string">`filter_exp`</span>, <span class="hljs-string">`status`</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10655</span> , <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) |<br>+<span class="hljs-comment">----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)<br></code></pre>

<p>可以看到，单库分表，受限很大，并且官方文档说单库分表，不支持join。</p>

<ul><li><strong><em>ER分片</em></strong> <br>
ER分片，子表的记录根据所关联的父表记录存放在同一分片上。下面以order、order_goods表为例。</li>
</ul>



<pre class="prettyprint hljs-dark"><code class="language-xml hljs">rule.xml<br><br><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span><br><span class="hljs-meta">&lt;!DOCTYPE mycat:rule SYSTEM "rule.dtd"&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:rule</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">"http://io.mycat/"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">tableRule</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user_id_long_partition"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">rule</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">columns</span>&gt;</span>user_id<span class="hljs-tag">&lt;/<span class="hljs-name">columns</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">algorithm</span>&gt;</span>func1<span class="hljs-tag">&lt;/<span class="hljs-name">algorithm</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">tableRule</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">function</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"func1"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"io.mycat.route.function.PartitionByLong"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"partitionCount"</span>&gt;</span>1,1<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"partitionLength"</span>&gt;</span>512,512<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">function</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:rule</span>&gt;</span><br><br>schema.xml<br><br><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span><br><span class="hljs-meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:schema</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">"http://io.mycat/"</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">"100"</span> &gt;</span><br>  <span class="hljs-comment">&lt;!--<br>  &lt;table name="lms_message_content" primaryKey="message_id" dataNode="message_shared" /&gt;<br>  &lt;table name="lms_message_recored" primaryKey="user_id" dataNode="message_shared" /&gt;<br><br>  &lt;table name="lms_message_send" primaryKey="ms_id" dataNode="message_shared" rule="to_user_id_long_partition" subTables="lms_message_send_1,lms_message_send_2,lms_message_send_3" /&gt;<br><br>  --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_order"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"order_id"</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">"message_shared,message_tmp"</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">"user_id_long_partition"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">childTable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lms_order_goods"</span> <span class="hljs-attr">joinKey</span>=<span class="hljs-string">"order_id"</span> <span class="hljs-attr">parentKey</span>=<span class="hljs-string">"order_id"</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"id"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message_shared"</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">database</span>=<span class="hljs-string">"mycat_lms"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"message_tmp"</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">database</span>=<span class="hljs-string">"tmp"</span> /&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ubuntu_130"</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">"1000"</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">writeType</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">"mysql"</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">"native"</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">"100"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">"hostM1"</span> <span class="hljs-attr">url</span>=<span class="hljs-string">"192.168.237.130:3307"</span> <span class="hljs-attr">user</span>=<span class="hljs-string">"root"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"qwer1111"</span> /&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:schema</span>&gt;</span><br></code></pre>

<p>准备sql语句和插入（注意，sql语句必须指定列名，且字表不支持批量插入）：</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">/usr/<span class="hljs-built_in">local</span>/mysql/bin/mysqldump -h192.168.237.130 -P3307 -uroot -p -c zt_lms -t --tables lms_order &gt;lms_order_order_goods.sql<br>/usr/<span class="hljs-built_in">local</span>/mysql/bin/mysqldump -h192.168.237.130 -P3307 -uroot -p -c zt_lms -t --skip-extended-insert --tables lms_order_goods  &gt;&gt;lms_order_order_goods.sql<br><br>mysql&gt; <span class="hljs-built_in">source</span> ~/lms_order_order_goods.sql<br></code></pre>

<p><img longdesc="./[4TA641DZ5Z7K{PV-4MLWNG.png" alt="Alt text" title="" type="image/png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAXgAAAEgCAMAAACJnpgOAAAAAXNSR0IArs4c6QAAAF1QTFRFAAAA/9uRZgAAZrf/AGa3OpHbAABm////ADqR25E6kToAt2YA/7dm29uR2///t/+3t///kdv////b//+3kdvb2//bqNSot//b2/+30dHmt5GRAGZmfDp8kZG327dm/1TJGQAABY5JREFUeNrt3Wtz2jgYBlAlYO7JQtrNbruX//8zF8s32RbgEEIn2XM+tC7C9mshmTKjZxx+ewylYh1WT+XG983xH7vjxvxbbJktXzbhr8ew+n1TvvgQOot639n6uPn38zacMd+NXmqOPD/+FVbl7uW5Q11H/63VabuWZqurNB5gsX9I39a1FuXrh+V6cNzqouqrmg1b2wtMt+p/749nmy+3JypoDnxOcwVJx9dnqfpqtksv/pD27qrbd7F/+Xu/fmPH1y913V1sw+EhzMfHqc806vik0qTbmrd1rfXWqGvrwXWi41ftWFoNR9Xij004U0H1wZyXGfGr52VUlbNNjtXvvt6Ifxx8KhM6fpsepfxrvls9fd/Mtv2x1ZYy7vik0mSv5m1da/1KcaLjq+bZNjsd8uN3Xh54faqCKR1fvb38BIcjvtc9IU7X7/0Cqs+4LCvuUt+HZsuHt3R8MuIXr8W6WL8+Duf0pRE/GK+DEd9tzU7caqrmwcXFO+BgK4zuN/kKptxq4ixaPa/rDtyXJ6l6sOiP+GPb62545l29b3X+asgfcnWe6fjqbHHf1x+b1Y+n0ayqb5yZe3xXaXWpRfy++POxKq1rjXfiYnSPD4d1OxXqCufLqvwi3rafeludeLxYc7aCZipd6PnjTIl9UJQb8RuoaKb3rLvnNMfsF17tW068Xblb/CB22VMs+5edHLloG8v6D+vxnP75fLyQeTWp69PVRbeVViepKi3a43V3zHIj1tfvwIf2Ouquajr+0NZ3SPug2a+7oGwFs3WY1PHfHqe8s9iFCYqXTfg02i/J2yrn3EWzY0cVudvylUXOduETmT98xFGnDOPJx2omNwAAAAAAAAAAAFwhLil+v3KBaL2Yt92abpwIaZfwFcvRIsZyTek6nGo9b9oSvsM71ualq4WLdsXt6OqWL//couO7taBnV4Vmsjx1B47DNtV60HYld9rv27DYr0+0Ti70tHjwuJr8ynHcrY8/nDnI/CYd/3Sxb9/Y8dUy7cVr+Wc/mBDfG4+Ua73BkK/fctjGFcNFNX/LFapx9B6H8nZeTrTFvmw5Tr/daN86EbI4n4EapWCaI1eTujztoZk9u8GMr17oVtkn6+3bSqvMzs+nOrvTrYqvWuOS+eJEMGH1b3zzeNrHsEK2NS5u/7HNVhAmBROk/i6l/nKtUn93SP1lO17q7+NTf9lWqb/M19mNU3/Z1qY2qb+PS/2lrSH99pD6+9jUX9qa/pKT+nsHqb9fReoPAAAAAAAAAACAr+1zp/7eXL3U3+Bzuyr1d0X1Un+XOn5K6u+a6qX+bpD6y3a81F+4x7P+RtVL/d3nWX/jjpf6u8ez/jLVS/1lvs5u/ay/bPVB6u/DU3+Z6qX+7pD6y1Uv9fdOUn+/itQfAAAAAAAAAAAAX9unTv0l+b+JpP4Gn9tVqb/kqX9vL/Q0qb9Lqb9e/u92Q17qb0LqbxxNkPoL90j99dNJQervXqm/1XBUSf3dJfWXGb9Sf5mvs1un/uYn/t8q9fexqb9e/i/99pD6+9jUX/rUv/SXnNTfO0j9/SpSfwAAAAAAAAAAAHxtnvWXrUfqz7P+zp/Ps/7SfT3rT+rPs/4mdbxn/QWpv+BZf571J/XnWX+e9Tfl16XUn9TfZVJ/AAAAAAAAAAAAfG1Sf9l6pP6k/s6fT+ov3VfqT+pP6m9Sx0v9Bam/IPUn9Sf1J/Un9Tfl16XUn9TfZVJ/AAAAAAAAAAAAfG1Sf9l6pP6k/s6fT+ov3VfqT+pP6m9Sx0v9Bam/IPUn9Sf1J/Un9Tfl16XUn9TfZVJ/AAAAAAAAAAAAfG1Sf9l6pP6k/s6fT+ov3VfqT+pP6m9Sx0v9Bam/IPUn9Sf1J/Un9Tfl16XUn9TfZVJ/AAAAAMD/zH/5wxkpPVpMiwAAAABJRU5ErkJggg==" class=""></p>

<p>实际测试发现，er分片后，子表的插入性能非常之低。将分片方式修改为固定hash分片后，插入速度明显提升。</p></div></body></html>