---
layout: article
title:  "php性能被动分析工具之tideways+xhgui加的安装部署"
tags: tideways xhgui加的安装部署 PHP性能分析
categories: 拓展
date: 2017-06-15 14:51:00
---
<div id='preview-contents' class='note-content'>
                        
                    



<h3 id="php性能被动分析工具之tideways+xhgui加的安装部署">PHP性能被动分析工具之tideways+xhgui加的安装部署</h3>

<p>php性能分析工具不多，之前用<code>xdebug</code>+<code>WinCacheGrind</code>，但是毕竟麻烦，每次都要生成文件，然后用<code>WinCacheGrind</code>查看。<code>xhprof</code>好久没更新，且对php7及以上版本无效。<code>tideways</code>+<code>xhgui</code>是个不错的选择。以下是针对PHP7.1+centos 6.8 的安装过程：</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><span class="hljs-comment">#安装tideways daemon</span><br>$ wget -Otideways-daemon.tar.gz <span class="hljs-string">"https://s3-eu-west-1.amazonaws.com/tideways/daemon/1.5.7/tideways-daemon_linux_amd64-1.5.7.tar.gz"</span><br>$ tar xzvf tideways-daemon.tar.gz<br>$ wget http://developer.axis.com/download/distribution/apps-sys-utils-start-stop-daemon-IR1_9_18-2.tar.gz<br>$ tar -xzvf apps-sys-utils-start-stop-daemon-IR1_9_18-2.tar.gz<br>$ <span class="hljs-built_in">cd</span> apps/sys-utils/start-stop-daemon-IR1_9_18-2<br>$ <span class="hljs-built_in">cd</span> tideways-daemon<br>$ cc start-stop-daemon.c -o start-stop-daemon<br>$  cp start-stop-daemon /usr/bin/start-stop-daemon<br>$ bash install.sh<br>$ /etc/init.d/tideways-daemon start<br><br><span class="hljs-comment">#安装tideways php扩展</span><br>$ wget -Otideways-php.tar.gz <span class="hljs-string">"https://s3-eu-west-1.amazonaws.com/tideways/extension/4.1.2/tideways-php-4.1.2-x86_64.tar.gz"</span><br>$ tar xzvf tideways-php.tar.gz<br>$ <span class="hljs-built_in">cd</span> tideways-php<br>$ <span class="hljs-built_in">cd</span> tideways-php-4.1.2<br>$ bash install.sh<br>$ vim /usr/<span class="hljs-built_in">local</span>/php/etc/php.ini <span class="hljs-comment">#添加扩展</span><br><span class="hljs-comment">#安装mongodb</span><br>$ wget http://downloads.mongodb.org/linux/mongodb-linux-x86_64-2.4.14.tgz<br>$ tar zxvf  mongodb-linux-x86_64-2.4.14.tgz<br>$ cp -R mongodb-linux-x86_64-2.4.14 /usr/<span class="hljs-built_in">local</span>/mongod<br>$ /usr/<span class="hljs-built_in">local</span>/mongod/bin/mongod --dbpath /usr/<span class="hljs-built_in">local</span>/mongod/data/ &amp; <span class="hljs-comment">#启动mongodb</span><br><span class="hljs-comment">#安装PHP的mongodb扩展</span><br>$ curl -O https://pecl.php.net/get/mongodb-1.2.3.tgz<br>$ tar -zxvf mongodb-1.2.3.tgz<br>$ <span class="hljs-built_in">cd</span> mongodb-1.2.3<br>$ /usr/<span class="hljs-built_in">local</span>/php/bin/phpize<br>$ ./configure --with-php-config=/usr/<span class="hljs-built_in">local</span>/php/bin/php-config<br>$ make &amp;&amp; make install <span class="hljs-comment">#修改php配置文件，添加扩展，重启PHP-fpm</span><br><span class="hljs-comment">#安装xhgui</span><br>$ git <span class="hljs-built_in">clone</span> https://github.com/maxincai/xhgui.git<br>$ <span class="hljs-built_in">cd</span> xhgui<br>$ chmod -R 0777 cache<br>$ php composer.phar install <span class="hljs-comment">#该命令一定要执行</span><br>$ php install.php <span class="hljs-comment">#需要PHP能执行proc系列函数，可能需要消耗较长是时间</span><br><br><span class="hljs-comment">#添加mongodb的索引</span><br>$ mongo<br>&gt; use xhprof<br>&gt; db.results.ensureIndex( { <span class="hljs-string">'meta.SERVER.REQUEST_TIME'</span> : -1 } )<br>&gt; db.results.ensureIndex( { <span class="hljs-string">'profile.main().wt'</span> : -1 } )<br>&gt; db.results.ensureIndex( { <span class="hljs-string">'profile.main().mu'</span> : -1 } )<br>&gt; db.results.ensureIndex( { <span class="hljs-string">'profile.main().cpu'</span> : -1 } )<br>&gt; db.results.ensureIndex( { <span class="hljs-string">'meta.url'</span> : 1 } );<br><br><span class="hljs-comment">#nginx配置，需要配置两类，一是xhgui的虚拟机，第二类是需要调试的项目的虚拟机</span><br></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-nginx hljs"><span class="hljs-section">server</span> {<br>    <span class="hljs-attribute">listen</span>   <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> <span class="hljs-literal">debug</span>.com;<br><br>    <span class="hljs-comment"># root directive should be global</span><br>    <span class="hljs-attribute">root</span>   /tools/xhgui/webroot/;<br>    <span class="hljs-attribute">index</span>  index.php;<br><br>    <span class="hljs-attribute">location</span> / {<br>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.php?<span class="hljs-variable">$args</span>;<br>    }<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {<br>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> =<span class="hljs-number">404</span>;<br>        <span class="hljs-attribute">include</span> /etc/nginx/fastcgi_params;<br>        <span class="hljs-attribute">fastcgi_pass</span>    <span class="hljs-number">127.0.0.1:9000</span>;<br>        <span class="hljs-attribute">fastcgi_index</span>   index.php;<br>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;<br>    }<br>}<br></code></pre>

<p>要调试的项目的nginx配置中添加：</p>

<pre class="prettyprint hljs-dark"><code class="language-nginx hljs"><span class="hljs-attribute">fastcgi_param</span> TIDEWAYS_SAMPLERATE <span class="hljs-string">"25"</span>;<br><span class="hljs-attribute">fastcgi_param</span> PHP_VALUE <span class="hljs-string">"auto_prepend_file=/tools/xhgui/external/header.php"</span>;<br></code></pre>

<p>以上就是大概的过程，相关文档：<a href="https://tideways.io/profiler/docs/setup/installation" target="_blank">tideways官网文档</a>、<a href="https://github.com/tideways/php-profiler-extension" target="_blank">tideways git项目</a>、<a href="https://github.com/perftools/xhgui" target="_blank">xhgui git项目</a></p></div></body></html>