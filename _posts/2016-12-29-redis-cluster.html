---
layout: article
title:  "python笔记"
tags: redis cluster
categories: redis
date: 2016-12-29 11:57:00
---
<div id='preview-contents' class='note-content'>
                        
                    



<h3 id="redis-clusterhigh-availabilit">redis cluster+High Availabilit</h3>

<p>redis集群和高可用在最新版本中，已经可以不借助其他工具而主实现了。但是，在使用redis cluster时，请先检查客户端是否支持cluster。首先开启多个redis实例(最少2个)，为了便于测试，我们开启6个节点</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># vim redis.conf</span><br>//在配置文件中追加配置<br>cluster-enabled yes<br>cluster-config-file nodes.conf<br>cluster-node-timeout 5000<br>appendonly yes<br>//copy redis.conf文件，并修改redis.conf中的port 和aof rdb pid cluster-config-file 文件路径<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis.conf redis_7000.conf</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis.conf redis_7001.conf</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis.conf redis_7002.conf</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis.conf redis_7003.conf</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis.conf redis_7004.conf</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis.conf redis_7005.conf</span><br></code></pre>

<p>redis新增加了redis-trib.rb脚本，通过该脚本来管理集群，该工具是使用ruby程序，所以我们需要安装ruby、以及ruby的redisclient</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment">#  apt-get install ruby-full</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># gem install redis</span><br></code></pre>

<table>
<thead>
<tr>
  <th align="center">代指</th>
  <th align="center">端口</th>
  <th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
  <td align="center">A</td>
  <td align="center">7000</td>
  <td align="center">主</td>
</tr>
<tr>
  <td align="center">B</td>
  <td align="center">7001</td>
  <td align="center">主</td>
</tr>
<tr>
  <td align="center">C</td>
  <td align="center">7002</td>
  <td align="center">主</td>
</tr>
<tr>
  <td align="center">A1</td>
  <td align="center">7003</td>
  <td align="center">A的从1</td>
</tr>
<tr>
  <td align="center">B1</td>
  <td align="center">7004</td>
  <td align="center">B的从1</td>
</tr>
<tr>
  <td align="center">C1</td>
  <td align="center">7005</td>
  <td align="center">C的从1</td>
</tr>
</tbody></table>


<p>接下来启动集群，启动前，可以先了解下</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb help</span><br>Usage: redis-trib &lt;<span class="hljs-built_in">command</span>&gt; &lt;options&gt; &lt;arguments ...&gt;<br><br>  create host1:port1 ... hostN:portN<br>  --replicas &lt;arg&gt;<br>  check host:port<br>  info host:port<br>  fix host:port<br>  --timeout &lt;arg&gt;<br>  reshard host:port<br>  --from &lt;arg&gt;<br>  --to &lt;arg&gt;<br>  --slots &lt;arg&gt;<br>  --yes<br>  --timeout &lt;arg&gt;<br>  --pipeline &lt;arg&gt;<br>  rebalance host:port<br>  --weight &lt;arg&gt;<br>  --auto-weights<br>  --use-empty-masters<br>  --timeout &lt;arg&gt;<br>  --simulate<br>  --pipeline &lt;arg&gt;<br>  --threshold &lt;arg&gt;<br>  add-node new_host:new_port existing_host:existing_port<br>  --slave<br>  --master-id &lt;arg&gt;<br>  del-node host:port node_id<br>  <span class="hljs-built_in">set</span>-timeout host:port milliseconds<br>  call host:port <span class="hljs-built_in">command</span> arg arg .. arg<br>  import host:port<br>  --from &lt;arg&gt;<br>  --copy<br>  --replace<br>  <span class="hljs-built_in">help</span> (show this <span class="hljs-built_in">help</span>)<br><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7000.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7001.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7002.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7003.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7004.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7005.conf &amp;</span><br><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span><br>&gt;&gt;&gt; Creating cluster<br>&gt;&gt;&gt; Performing <span class="hljs-built_in">hash</span> slots allocation on 6 nodes...<br>Using 3 masters:<br>127.0.0.1:7000<br>127.0.0.1:7001<br>127.0.0.1:7002<br>Adding replica 127.0.0.1:7003 to 127.0.0.1:7000<br>Adding replica 127.0.0.1:7004 to 127.0.0.1:7001<br>Adding replica 127.0.0.1:7005 to 127.0.0.1:7002<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:0-5460 (5461 slots) master<br>M: 838da243d79cf3a9de22ff4503e476ddf54186d9 127.0.0.1:7001<br>  slots:5461-10922 (5462 slots) master<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:10923-16383 (5461 slots) master<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>S: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  replicates 838da243d79cf3a9de22ff4503e476ddf54186d9<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">'yes'</span> to accept):<br>//输出的信息非常清楚的表示了哪些是主，哪些是从，谁是谁的从，以及分到的哈希槽，输入yes表示接收<br><br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>45945:S 29 Dec 10:55:00.570 * Connecting to MASTER 127.0.0.1:7002<br>45945:S 29 Dec 10:55:00.570 * MASTER &lt;-&gt; SLAVE sync started<br>45945:S 29 Dec 10:55:00.570 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>45945:S 29 Dec 10:55:00.570 * Master replied to PING, replication can continue...<br>45945:S 29 Dec 10:55:00.570 * Partial resynchronization not possible (no cached master)<br>45935:M 29 Dec 10:55:00.570 * Slave 127.0.0.1:7005 asks <span class="hljs-keyword">for</span> synchronization<br>45935:M 29 Dec 10:55:00.570 * Full resync requested by slave 127.0.0.1:7005<br>45935:M 29 Dec 10:55:00.570 * Starting BGSAVE <span class="hljs-keyword">for</span> SYNC with target: disk<br>45935:M 29 Dec 10:55:00.574 * Background saving started by pid 46029<br>45945:S 29 Dec 10:55:00.577 * Full resync from master: 90607ccc589be598df45d65b3a5e1130b858bb07:1<br>46029:C 29 Dec 10:55:00.580 * DB saved on disk<br>46029:C 29 Dec 10:55:00.580 * RDB: 6 MB of memory used by copy-on-write<br>[OK] All 16384 slots covered.<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># 45935:M 29 Dec 10:55:00.665 * Background saving terminated with success</span><br>45935:M 29 Dec 10:55:00.665 * Synchronization with slave 127.0.0.1:7005 succeeded<br>45945:S 29 Dec 10:55:00.665 * MASTER &lt;-&gt; SLAVE sync: receiving 76 bytes from master<br>45945:S 29 Dec 10:55:00.665 * MASTER &lt;-&gt; SLAVE sync: Flushing old data<br>45945:S 29 Dec 10:55:00.665 * MASTER &lt;-&gt; SLAVE sync: Loading DB <span class="hljs-keyword">in</span> memory<br>45945:S 29 Dec 10:55:00.665 * MASTER &lt;-&gt; SLAVE sync: Finished with success<br>45942:S 29 Dec 10:55:00.877 * Connecting to MASTER 127.0.0.1:7001<br>45942:S 29 Dec 10:55:00.877 * MASTER &lt;-&gt; SLAVE sync started<br>45942:S 29 Dec 10:55:00.877 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>45942:S 29 Dec 10:55:00.878 * Master replied to PING, replication can continue...<br>45942:S 29 Dec 10:55:00.878 * Partial resynchronization not possible (no cached master)<br>45932:M 29 Dec 10:55:00.878 * Slave 127.0.0.1:7004 asks <span class="hljs-keyword">for</span> synchronization<br>45932:M 29 Dec 10:55:00.878 * Full resync requested by slave 127.0.0.1:7004<br>45932:M 29 Dec 10:55:00.878 * Starting BGSAVE <span class="hljs-keyword">for</span> SYNC with target: disk<br>45932:M 29 Dec 10:55:00.879 * Background saving started by pid 46030<br>45942:S 29 Dec 10:55:00.882 * Full resync from master: 878ccbb3e6f2730522b77c926d0f97a81c2ee65b:1<br>46030:C 29 Dec 10:55:00.884 * DB saved on disk<br>46030:C 29 Dec 10:55:00.884 * RDB: 6 MB of memory used by copy-on-write<br>45932:M 29 Dec 10:55:00.963 * Background saving terminated with success<br>45942:S 29 Dec 10:55:00.963 * MASTER &lt;-&gt; SLAVE sync: receiving 76 bytes from master<br>45932:M 29 Dec 10:55:00.963 * Synchronization with slave 127.0.0.1:7004 succeeded<br>45942:S 29 Dec 10:55:00.964 * MASTER &lt;-&gt; SLAVE sync: Flushing old data<br>45942:S 29 Dec 10:55:00.964 * MASTER &lt;-&gt; SLAVE sync: Loading DB <span class="hljs-keyword">in</span> memory<br>45942:S 29 Dec 10:55:00.964 * MASTER &lt;-&gt; SLAVE sync: Finished with success<br>45938:S 29 Dec 10:55:01.465 * Connecting to MASTER 127.0.0.1:7000<br>45938:S 29 Dec 10:55:01.465 * MASTER &lt;-&gt; SLAVE sync started<br>45938:S 29 Dec 10:55:01.466 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>45938:S 29 Dec 10:55:01.466 * Master replied to PING, replication can continue...<br>45938:S 29 Dec 10:55:01.466 * Partial resynchronization not possible (no cached master)<br>45929:M 29 Dec 10:55:01.467 * Slave 127.0.0.1:7003 asks <span class="hljs-keyword">for</span> synchronization<br>45929:M 29 Dec 10:55:01.467 * Full resync requested by slave 127.0.0.1:7003<br>45929:M 29 Dec 10:55:01.467 * Starting BGSAVE <span class="hljs-keyword">for</span> SYNC with target: disk<br>45932:M 29 Dec 10:55:01.468 <span class="hljs-comment"># Cluster state changed: ok</span><br>45935:M 29 Dec 10:55:01.478 <span class="hljs-comment"># Cluster state changed: ok</span><br>45929:M 29 Dec 10:55:01.480 * Background saving started by pid 46036<br>45938:S 29 Dec 10:55:01.483 * Full resync from master: d493815972f9fe6951b1c0d205dccc54cc518a3b:1<br>45929:M 29 Dec 10:55:01.487 <span class="hljs-comment"># Cluster state changed: ok</span><br>46036:C 29 Dec 10:55:01.489 * DB saved on disk<br>46036:C 29 Dec 10:55:01.490 * RDB: 6 MB of memory used by copy-on-write<br>45929:M 29 Dec 10:55:01.587 * Background saving terminated with success<br>45938:S 29 Dec 10:55:01.588 * MASTER &lt;-&gt; SLAVE sync: receiving 76 bytes from master<br>45929:M 29 Dec 10:55:01.588 * Synchronization with slave 127.0.0.1:7003 succeeded<br>45938:S 29 Dec 10:55:01.588 * MASTER &lt;-&gt; SLAVE sync: Flushing old data<br>45938:S 29 Dec 10:55:01.588 * MASTER &lt;-&gt; SLAVE sync: Loading DB <span class="hljs-keyword">in</span> memory<br>45938:S 29 Dec 10:55:01.588 * MASTER &lt;-&gt; SLAVE sync: Finished with success<br></code></pre>

<p>创建成功了，然后我们登录cluster</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-cli -c -h 127.0.0.1 -p 7001 //随便登录其中一台node，记住，用cli登录的时候，加上-c参数</span><br>127.0.0.1:7002&gt; <span class="hljs-built_in">set</span> name:1 a<br>OK<br>127.0.0.1:7002&gt; <span class="hljs-built_in">set</span> name:2 a<br>-&gt; Redirected to slot [182] located at 127.0.0.1:7000<br>OK<br>127.0.0.1:7000&gt; 45938:S 29 Dec 11:01:08.568 * 1 changes <span class="hljs-keyword">in</span> 900 seconds. Saving...<br>  45938:S 29 Dec 11:01:08.570 * Background saving started by pid 46086<br>  46086:C 29 Dec 11:01:08.574 * DB saved on disk<br>  46086:C 29 Dec 11:01:08.574 * RDB: 6 MB of memory used by copy-on-write<br>  45938:S 29 Dec 11:01:08.672 * Background saving terminated with success<br>127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> name:3 a<br>OK<br>127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> name:4 a<br>-&gt; Redirected to slot [8304] located at 127.0.0.1:7001<br>OK<br>127.0.0.1:7001&gt; 45942:S 29 Dec 11:02:05.055 * 1 changes <span class="hljs-keyword">in</span> 900 seconds. Saving...<br>  45942:S 29 Dec 11:02:05.056 * Background saving started by pid 46093<br>  46093:C 29 Dec 11:02:05.058 * DB saved on disk<br>  46093:C 29 Dec 11:02:05.058 * RDB: 2 MB of memory used by copy-on-write<br>  45942:S 29 Dec 11:02:05.158 * Background saving terminated with success<br>127.0.0.1:7001&gt;<br>127.0.0.1:7001&gt; <span class="hljs-built_in">set</span> name:5 a<br>-&gt; Redirected to slot [12369] located at 127.0.0.1:7002<br>OK<br>127.0.0.1:7002&gt; <span class="hljs-built_in">set</span> name:6 a<br>-&gt; Redirected to slot [50] located at 127.0.0.1:7000<br>OK<br>127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> name:7 a<br>OK<br>127.0.0.1:7000&gt;<br></code></pre>

<p>多次set后，会发现，只会在主库之间设置。我们已经在 127.0.0.1:7001设置了 name:4 这个属性了，接下来将7001这个服务关闭或者拒绝服务</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">127.0.0.1:7001&gt; DEBUG SEGFAULT<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ps aux |grep redis</span><br>root 1662 0.0 0.7 276824 15696 ? Ssl 12月27 2:23 /usr/<span class="hljs-built_in">local</span>/redis/redis-server /usr/<span class="hljs-built_in">local</span>/redis/redis.conf<br>root 45929 0.2 0.5 40208 11888 pts/23 Sl 10:43 0:02 ./redis-server 127.0.0.1:7000 [cluster]<br>root 45935 0.2 0.5 40208 11888 pts/23 Sl 10:43 0:02 ./redis-server 127.0.0.1:7002 [cluster]<br>root 45938 0.2 0.4 38160 9868 pts/23 Sl 10:43 0:02 ./redis-server 127.0.0.1:7003 [cluster]<br>root 45942 0.2 0.3 38160 7840 pts/23 Sl 10:43 0:02 ./redis-server 127.0.0.1:7004 [cluster]<br>root 45945 0.2 0.2 38160 5000 pts/23 Sl 10:43 0:02 ./redis-server 127.0.0.1:7005 [cluster]<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb check 127.0.0.1:7000</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:0-5460 (5461 slots) master<br>  1 additional replica(s)<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  slots: (0 slots) slave<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>M: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  slots:5461-10922 (5462 slots) master<br>  0 additional replica(s)<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  slots: (0 slots) slave<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:10923-16383 (5461 slots) master<br>  1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre>

<p>可以看到 7004已经变成master了。登录进去，获取name:4这个属性值</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-cli -c -h 127.0.0.1 -p 7000</span><br>127.0.0.1:7000&gt; get name:4<br>-&gt; Redirected to slot [8304] located at 127.0.0.1:7004<br><span class="hljs-string">"a"</span><br>127.0.0.1:7004&gt;<br></code></pre>

<p>重新启动7001后，会发现 127.0.0.1:7001变成了 127.0.0.1:7004的slave。注意：如果不是cluster模式连接redis，默认的，不能在从库上进行read和write</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7001.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb check 127.0.0.1:7000</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:0-5460 (5461 slots) master<br>  1 additional replica(s)<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  slots: (0 slots) slave<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>M: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  slots:5461-10922 (5462 slots) master<br>  1 additional replica(s)<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  slots: (0 slots) slave<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:10923-16383 (5461 slots) master<br>  1 additional replica(s)<br>S: 838da243d79cf3a9de22ff4503e476ddf54186d9 127.0.0.1:7001<br>  slots: (0 slots) slave<br>  replicates 2a34b7d7f4728802be924e77d2e1e534177908b4<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre>

<p>可以看到redis能够非常好的完成故障转移，提供集群服务的同时，还能满足高可用的要求。通过./redis-trib.rb 还可以添加、删除节点、添加从、删除从节点的操作。添加一个主节点试下</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># cp redis_7001.conf redis_7006.conf</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># vim redis_7006.conf  //修改port等信息</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-server redis_7006.conf &amp;</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb add-node 127.0.0.1:7006 127.0.0.1:7000</span><br>&gt;&gt;&gt; Adding node 127.0.0.1:7006 to cluster 127.0.0.1:7000<br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:0-5460 (5461 slots) master<br>  1 additional replica(s)<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  slots: (0 slots) slave<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>M: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  slots:5461-10922 (5462 slots) master<br>  1 additional replica(s)<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  slots: (0 slots) slave<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:10923-16383 (5461 slots) master<br>  1 additional replica(s)<br>S: 838da243d79cf3a9de22ff4503e476ddf54186d9 127.0.0.1:7001<br>  slots: (0 slots) slave<br>  replicates 2a34b7d7f4728802be924e77d2e1e534177908b4<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>&gt;&gt;&gt; Send CLUSTER MEET to node 127.0.0.1:7006 to make it join the cluster.<br>[OK] New node added correctly.<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># 46420:M 29 Dec 11:29:59.325 # IP address for this node updated to 127.0.0.1</span><br>46420:M 29 Dec 11:30:04.285 <span class="hljs-comment"># Cluster state changed: ok</span><br><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb check 127.0.0.1:7000</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:0-5460 (5461 slots) master<br>  1 additional replica(s)<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  slots: (0 slots) slave<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>M: 396dbec876ba3753d41b233778ec0a2d50bc73d3 127.0.0.1:7006<br>  slots: (0 slots) master<br>  0 additional replica(s)<br>M: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  slots:5461-10922 (5462 slots) master<br>  1 additional replica(s)<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  slots: (0 slots) slave<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:10923-16383 (5461 slots) master<br>  1 additional replica(s)<br>S: 838da243d79cf3a9de22ff4503e476ddf54186d9 127.0.0.1:7001<br>  slots: (0 slots) slave<br>  replicates 2a34b7d7f4728802be924e77d2e1e534177908b4<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre>

<p>可以看到 7006已经成功作为主节点加入到cluster，但是，cluster并没有分区solt给它，也就是说，这个主节点将不会分配到任何操作。通过<code>reshard</code>，重新分配整个cluster的哈希槽</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb reshard 127.0.0.1:7001</span><br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb reshard 127.0.0.1:7001</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7001)<br>S: 838da243d79cf3a9de22ff4503e476ddf54186d9 127.0.0.1:7001<br>  slots: (0 slots) slave<br>  replicates 2a34b7d7f4728802be924e77d2e1e534177908b4<br>M: 396dbec876ba3753d41b233778ec0a2d50bc73d3 127.0.0.1:7006<br>  slots: (0 slots) master<br>  0 additional replica(s)<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:10923-16383 (5461 slots) master<br>  1 additional replica(s)<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:0-5460 (5461 slots) master<br>  1 additional replica(s)<br>M: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  slots:5461-10922 (5462 slots) master<br>  1 additional replica(s)<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  slots: (0 slots) slave<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  slots: (0 slots) slave<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>How many slots <span class="hljs-keyword">do</span> you want to move (from 1 to 16384)? 4000<br>What is the receiving node ID? 396dbec876ba3753d41b233778ec0a2d50bc73d3<br>Please enter all the <span class="hljs-built_in">source</span> node IDs.<br>  Type <span class="hljs-string">'all'</span> to use all the nodes as <span class="hljs-built_in">source</span> nodes <span class="hljs-keyword">for</span> the <span class="hljs-built_in">hash</span> slots.<br>  Type <span class="hljs-string">'done'</span> once you entered all the <span class="hljs-built_in">source</span> nodes IDs.<br>Source node <span class="hljs-comment">#1:all</span><br>.....<br>.....<br>  Moving slot 1329 from 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>  Moving slot 1330 from 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>  Moving slot 1331 from 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>  Moving slot 1332 from 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>Do you want to proceed with the proposed reshard plan (yes/no)?yes<br>.....<br>.....<br>Moving slot 1327 from 127.0.0.1:7000 to 127.0.0.1:7006:<br>Moving slot 1328 from 127.0.0.1:7000 to 127.0.0.1:7006:<br>Moving slot 1329 from 127.0.0.1:7000 to 127.0.0.1:7006:<br>Moving slot 1330 from 127.0.0.1:7000 to 127.0.0.1:7006:<br>Moving slot 1331 from 127.0.0.1:7000 to 127.0.0.1:7006:<br>Moving slot 1332 from 127.0.0.1:7000 to 127.0.0.1:7006:<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb check 127.0.0.1:7001</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7001)<br>S: 838da243d79cf3a9de22ff4503e476ddf54186d9 127.0.0.1:7001<br>  slots: (0 slots) slave<br>  replicates 2a34b7d7f4728802be924e77d2e1e534177908b4<br>M: 396dbec876ba3753d41b233778ec0a2d50bc73d3 127.0.0.1:7006<br>  slots:0-1332,5461-6794,10923-12255 (4000 slots) master<br>  0 additional replica(s)<br>M: de8f22a3a2d57a141d90216b8528fa1fcda77738 127.0.0.1:7002<br>  slots:12256-16383 (4128 slots) master<br>  1 additional replica(s)<br>M: 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79 127.0.0.1:7000<br>  slots:1333-5460 (4128 slots) master<br>  1 additional replica(s)<br>M: 2a34b7d7f4728802be924e77d2e1e534177908b4 127.0.0.1:7004<br>  slots:6795-10922 (4128 slots) master<br>  1 additional replica(s)<br>S: afa68cc7c846445bb142953a13bf8bea5d5f2655 127.0.0.1:7005<br>  slots: (0 slots) slave<br>  replicates de8f22a3a2d57a141d90216b8528fa1fcda77738<br>S: 5b6d97aa748545090b22f88949d450f86f237fcd 127.0.0.1:7003<br>  slots: (0 slots) slave<br>  replicates 8e1fadf4b6145b32062d8d6c6bb148<span class="hljs-built_in">cd</span>8e39ae79<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>//可以看到7006的哈希槽是间断的<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment">#</span><br></code></pre>

<p>删除主节点7006：</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb del-node 127.0.1:7001 396dbec876ba3753d41b233778ec0a2d50bc73d3</span><br>&gt;&gt;&gt; Removing node 396dbec876ba3753d41b233778ec0a2d50bc73d3 from cluster 127.0.1:7001<br>[ERR] Node 127.0.0.1:7006 is not empty! Reshard data away and try again.<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ./redis-trib.rb del-node 127.0.1:7001 838da243d79cf3a9de22ff4503e476ddf54186d9</span><br>&gt;&gt;&gt; Removing node 838da243d79cf3a9de22ff4503e476ddf54186d9 from cluster 127.0.1:7001<br>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...<br>&gt;&gt;&gt; SHUTDOWN the node.<br>46284:S 29 Dec 11:44:48.985 <span class="hljs-comment"># User requested shutdown...</span><br>46284:S 29 Dec 11:44:48.985 * Saving the final RDB snapshot before exiting.<br>46284:S 29 Dec 11:44:48.988 * DB saved on disk<br>46284:S 29 Dec 11:44:48.988 * Removing the pid file.<br>46284:S 29 Dec 11:44:48.988 <span class="hljs-comment"># Redis is now ready to exit, bye bye...</span><br>[1]- Done ./redis-server redis_7001.conf<br>root@pz:/usr/<span class="hljs-built_in">local</span>/redis-3.2.6<span class="hljs-comment"># ps aux |grep redis</span><br>root 1662 0.0 0.7 276824 15696 ? Ssl 12月27 2:24 /usr/<span class="hljs-built_in">local</span>/redis/redis-server /usr/<span class="hljs-built_in">local</span>/redis/redis.conf<br>root 45929 0.3 0.5 40208 11908 pts/23 Sl 10:43 0:12 ./redis-server 127.0.0.1:7000 [cluster]<br>root 45935 0.3 0.5 40208 11896 pts/23 Sl 10:43 0:12 ./redis-server 127.0.0.1:7002 [cluster]<br>root 45938 0.2 0.4 38160 9868 pts/23 Sl 10:43 0:09 ./redis-server 127.0.0.1:7003 [cluster]<br>root 45942 0.3 0.4 40208 9900 pts/23 Sl 10:43 0:12 ./redis-server 127.0.0.1:7004 [cluster]<br>root 45945 0.2 0.3 38160 7880 pts/23 Sl 10:43 0:09 ./redis-server 127.0.0.1:7005 [cluster]<br>root 46420 0.7 0.3 38160 7860 pts/22 Sl 11:28 0:06 ./redis-server 127.0.0.1:7006 [cluster]<br>root 46581 0.0 0.2 14348 5828 pts/23 S+ 11:42 0:00 ./redis-cli -h 127.0.0.1 -p 7006 -c<br></code></pre>

<p>会发现，主节点有分配哈希槽时，是不能被删除的，但是从节点可以被删除，并且一旦删除，对应的服务也会推出。</p></div></body></html>