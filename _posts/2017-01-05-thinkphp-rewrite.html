---
layout: article
title:  "thinkphp路由规则解析及支持pathinfo"
tags: thinkphp rewrite
categories: php
date: 2017-01-05 17:15:00
---
<div id='preview-contents' class='note-content'>
                        
                    



<h3 id="thinkphp路由规则解析及支持pathinfo">thinkphp路由规则解析及支持pathinfo</h3>

<p>一般，我们都喜欢让url简短好看些，访问框架下的某个方法基本分为应用-&gt;控制器-&gt;方法，比如<code>http://local.api.com/index.php/Apistore/Test/test</code>，Apistore是tp下的而某个应用，Test是控制器，test是Test下的一个方法。但是这种url是不符合url标准的，符合标准的url应该是类似<code>http://local.api.com/index.php?a=Apistore&amp;c=Test&amp;m=test</code>，但是这种url不友好，不好看。所以大部分框架会借助环境变量中的<code>path_info</code>，通过分析<code>pathinfo</code>来得到要执行的控制器和方法。但是这种方式并不是所有的web服务器都支持，大名鼎鼎的nginx就不支持，这就导致很多开发者经常遇到在nginx环境下，经常报404或者500错误，那么如何让thinkPHP在nginx下依然可以用<code>http://local.api.com/index.php/Apistore/Test/test</code>这种方式访问了？</p>

<p>在<code>ThinkPHP/Conf/convention.php</code>第154行，有如下配置：</p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-string">'VAR_MODULE'</span> =&gt; <span class="hljs-string">'m'</span>, <span class="hljs-comment">// 默认模块获取变量</span><br><span class="hljs-string">'VAR_ADDON'</span> =&gt; <span class="hljs-string">'addon'</span>, <span class="hljs-comment">// 默认的插件控制器命名空间变量</span><br><span class="hljs-string">'VAR_CONTROLLER'</span> =&gt; <span class="hljs-string">'c'</span>, <span class="hljs-comment">// 默认控制器获取变量</span><br><span class="hljs-string">'VAR_ACTION'</span> =&gt; <span class="hljs-string">'a'</span>, <span class="hljs-comment">// 默认操作获取变量</span><br><span class="hljs-string">'VAR_AJAX_SUBMIT'</span> =&gt; <span class="hljs-string">'ajax'</span>, <span class="hljs-comment">// 默认的AJAX提交变量</span><br><span class="hljs-string">'VAR_JSONP_HANDLER'</span> =&gt; <span class="hljs-string">'callback'</span>,<br><span class="hljs-string">'VAR_PATHINFO'</span> =&gt; <span class="hljs-string">'s'</span>, <span class="hljs-comment">// 兼容模式PATHINFO获取变量例如 ?s=/module/action/id/1 后面的参数取决于URL_PATHINFO_DEPR</span><br></code></pre>

<p>也就是说，tp的路由是根据m来获取模块值，c来获取控制器值，a获取方法值，所以在任何平台下，通过<code>http://local.api.com/index.php?m=Apistore&amp;c=Test&amp;a=test</code>都是可以正确访问到的。然后看<code>VAR_PATHINFO</code>，值为<code>s</code>，在来看 <br>
<code>ThinkPHP/Library/Think/Dispatcher.class.php</code> 第30行</p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[$varPath])) { <span class="hljs-comment">// 判断URL里面是否有兼容模式参数</span><br>     $_SERVER[<span class="hljs-string">'PATH_INFO'</span>] = $_GET[$varPath];<br>     <span class="hljs-keyword">unset</span>($_GET[$varPath]);<br>}<span class="hljs-keyword">elseif</span>(IS_CLI){ <span class="hljs-comment">// CLI模式下 index.php module/controller/action/params/...</span><br>     $_SERVER[<span class="hljs-string">'PATH_INFO'</span>] = <span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">'argv'</span>][<span class="hljs-number">1</span>]) ? $_SERVER[<span class="hljs-string">'argv'</span>][<span class="hljs-number">1</span>] : <span class="hljs-string">''</span>;<br>}<br></code></pre>

<p>也就是说，如果get中有<code>s</code>这个变量，则将s的值赋给<code>path_info</code>。</p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-keyword">if</span> (__INFO__ &amp;&amp; !defined(<span class="hljs-string">'BIND_MODULE'</span>) &amp;&amp; C(<span class="hljs-string">'MULTI_MODULE'</span>)){ <span class="hljs-comment">// 获取模块名</span><br>     $paths = explode($depr,__INFO__,<span class="hljs-number">2</span>);<br>     $allowList = C(<span class="hljs-string">'MODULE_ALLOW_LIST'</span>); <span class="hljs-comment">// 允许的模块列表</span><br>     $module = preg_replace(<span class="hljs-string">'/.'</span> . __EXT__ . <span class="hljs-string">'$/i'</span>, <span class="hljs-string">''</span>,$paths[<span class="hljs-number">0</span>]);<br>     <span class="hljs-keyword">if</span>( <span class="hljs-keyword">empty</span>($allowList) || (is_array($allowList) &amp;&amp; in_array_case($module, $allowList))){<br>          $_GET[$varModule] = $module;<br>          $_SERVER[<span class="hljs-string">'PATH_INFO'</span>] = <span class="hljs-keyword">isset</span>($paths[<span class="hljs-number">1</span>])?$paths[<span class="hljs-number">1</span>]:<span class="hljs-string">''</span>;<br>     }<br>}<br></code></pre>

<p>用/分隔<code>path_info</code>，第一个值赋值给<code>module</code>，剩下的继续当做<code>path_info</code></p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-keyword">if</span>(!defined(<span class="hljs-string">'BIND_CONTROLLER'</span>)) {<span class="hljs-comment">// 获取控制器</span><br><span class="hljs-keyword">if</span>(C(<span class="hljs-string">'CONTROLLER_LEVEL'</span>)&gt;<span class="hljs-number">1</span>){<span class="hljs-comment">// 控制器层次</span><br>     $_GET[$varController] = implode(<span class="hljs-string">'/'</span>,array_slice($paths,<span class="hljs-number">0</span>,C(<span class="hljs-string">'CONTROLLER_LEVEL'</span>)));<br>     $paths = array_slice($paths, C(<span class="hljs-string">'CONTROLLER_LEVEL'</span>));<br>}<span class="hljs-keyword">else</span>{<br>     $_GET[$varController] = array_shift($paths);<br>}<br>}<br><span class="hljs-comment">// 获取操作</span><br><span class="hljs-keyword">if</span>(!defined(<span class="hljs-string">'BIND_ACTION'</span>)){<br>     $_GET[$varAction] = array_shift($paths);<br>}<br></code></pre>

<p>接着就是获取到c、a的值，在<code>http://local.api.com/abc/index.php/Apistore/Test/test</code>这个url中，c和a的值分别为Test和test，就是用/切割，依次赋值给a和c。在137和233行，通过get参数绑定给常量，同时删除<code>$_GET</code> 和 <code>$_REQUEST</code>中，这些m、a、c的值，所以，我们在开发中，get传值的key千万不能和框架内定义的这些重合。</p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-comment">// 获取模块名称</span><br>define(<span class="hljs-string">'MODULE_NAME'</span>, defined(<span class="hljs-string">'BIND_MODULE'</span>)? BIND_MODULE : <span class="hljs-keyword">self</span>::getModule($varModule));<br><br> <span class="hljs-comment">// 获取控制器和操作名</span><br>define(<span class="hljs-string">'CONTROLLER_NAME'</span>, defined(<span class="hljs-string">'BIND_CONTROLLER'</span>)? BIND_CONTROLLER : <span class="hljs-keyword">self</span>::getController($varController,$urlCase));<br>define(<span class="hljs-string">'ACTION_NAME'</span>, defined(<span class="hljs-string">'BIND_ACTION'</span>)? BIND_ACTION : <span class="hljs-keyword">self</span>::getAction($varAction,$urlCase));<br></code></pre>

<p>从这些代码中，可以知道，tp解析参数是是通过get中的s参数以及<code>$_SERVER</code>中的<code>path_info</code>来解析的，s参数会覆盖<code>path_info</code>。以上这些没有问题，但是tp框架内部还定义了几个常量，<code>__APP__</code>、<code>__ROOT__</code>，接着来看这两个常量定义的规则。在<code>ThinkPHP/ThinkPHP.php</code> 第79行</p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-keyword">if</span>(!defined(<span class="hljs-string">'_PHP_FILE_'</span>)) {<br><span class="hljs-keyword">if</span>(IS_CGI) {<br>     <span class="hljs-comment">//CGI/FASTCGI模式下</span><br>     $_temp = explode(<span class="hljs-string">'.php'</span>,$_SERVER[<span class="hljs-string">'PHP_SELF'</span>]);<br>     define(<span class="hljs-string">'_PHP_FILE_'</span>, rtrim(str_replace($_SERVER[<span class="hljs-string">'HTTP_HOST'</span>],<span class="hljs-string">''</span>,$_temp[<span class="hljs-number">0</span>].<span class="hljs-string">'.php'</span>),<span class="hljs-string">'/'</span>));<br>}<span class="hljs-keyword">else</span> {<br>     define(<span class="hljs-string">'_PHP_FILE_'</span>, rtrim($_SERVER[<span class="hljs-string">'SCRIPT_NAME'</span>],<span class="hljs-string">'/'</span>));<br>}<br>}<br><span class="hljs-keyword">if</span>(!defined(<span class="hljs-string">'__ROOT__'</span>)) {<br>$_root = rtrim(dirname(_PHP_FILE_),<span class="hljs-string">'/'</span>);<br>define(<span class="hljs-string">'__ROOT__'</span>, (($_root==<span class="hljs-string">'/'</span> || $_root==<span class="hljs-string">'\')?'</span><span class="hljs-string">':$_root));<br>}</span><br></code></pre>

<p><code>__ROOT__</code>这个常量就是取<code>$_SERVER[‘PHP_SELF’]</code>的目录(通过.php切割该变量，获得第一个元素的目录名)，假设访问的是<code>http://local.api.com/abc/index.php/Apistore/Test/test</code>这个路径，那么<code>__ROOT__</code>的值就为 abc，<code>_PHP_FILE_</code>这个常量就是<code>/abc/index.php</code>，这里为abc。ok，接下来看<code>__APP__</code>的定义。在<code>ThinkPHP/Library/Think/Dispatcher.class.php</code>第175行中</p>

<pre class="prettyprint hljs-dark"><code class="language-php hljs"><span class="hljs-keyword">if</span>(!defined(<span class="hljs-string">'__APP__'</span>)){<br>$urlMode = C(<span class="hljs-string">'URL_MODEL'</span>);<br><span class="hljs-keyword">if</span>($urlMode == URL_COMPAT ){<span class="hljs-comment">// 兼容模式判断</span><br><br>     define(<span class="hljs-string">'PHP_FILE'</span>,_PHP_FILE_.<span class="hljs-string">'?'</span>.$varPath.<span class="hljs-string">'='</span>);<br>}<span class="hljs-keyword">elseif</span>($urlMode == URL_REWRITE ) {<br>$url = dirname(_PHP_FILE_);<br><span class="hljs-keyword">if</span>($url == <span class="hljs-string">'/'</span> || $url == <span class="hljs-string">'\')<br>$url = '</span><span class="hljs-string">';<br>define('</span>PHP_FILE<span class="hljs-string">',$url);<br>}else {<br>          define('</span>PHP_FILE<span class="hljs-string">',_PHP_FILE_);<br>}<br>// 当前应用地址<br>define('</span>__APP__<span class="hljs-string">',strip_tags(PHP_FILE));<br>}</span><br></code></pre>

<p>这段代码就是根据<code>URL_MODEL</code>的值，而设置<code>__APP__</code>的值。以上讲了这么多，总结起来就是解析url的时候，是通过path_info。但是<code>path_info</code>这个功能是php的 ，nginx作为web服务器并没有实现这个功能，所以在nginx下，这个值是空的，但我们可以通过正则来使得php能获取<code>path_info</code>变量值。</p>

<pre class="prettyprint hljs-dark"><code class="language-nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ .php/?.*$</span> {<br>    <span class="hljs-attribute">root</span> /mnt/share/www/backend/branches/dev;<br>    <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>    <span class="hljs-comment">#fastcgi_index index.php;</span><br>    <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME /scripts<span class="hljs-variable">$fastcgi_script_name</span>;<br>    <span class="hljs-attribute">include</span> fastcgi_params;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$path_info</span> <span class="hljs-string">""</span>;<br>    <span class="hljs-comment">#定义变量 $real_script_name，用于存放真实地址</span><br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$real_script_name</span> <span class="hljs-variable">$fastcgi_script_name</span>;<br>    <span class="hljs-comment">#如果地址与引号内的正则表达式匹配</span><br>    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$fastcgi_script_name</span> <span class="hljs-regexp">~ "^(.+?.php)(/.+)$")</span> {<br>    <span class="hljs-comment">#将文件地址赋值给变量 $real_script_name</span><br>        <span class="hljs-attribute">set</span> <span class="hljs-variable">$real_script_name</span> <span class="hljs-variable">$1</span>;<br>        <span class="hljs-comment">#将文件地址后的参数赋值给变量 $path_info</span><br>        <span class="hljs-attribute">set</span> <span class="hljs-variable">$path_info</span> <span class="hljs-variable">$2</span>;<br>    }<br>    <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$real_script_name</span>;<br>    <span class="hljs-attribute">fastcgi_param</span> SCRIPT_NAME <span class="hljs-variable">$real_script_name</span>;<br>    <span class="hljs-attribute">fastcgi_param</span> PATH_INFO <span class="hljs-variable">$path_info</span>;<br>}<br></code></pre>

<p>这样的话，path_info这个变量就有值了，但是，当php的配置cgi.fix_pathinfo为0时，$_SERVER中的PHP_SELF值就有问题了，打印出来发现值为/Apistore/Test/test而不是index.php/Apistore/Test/test，这个错误直接导致<code>__APP__</code>、<code>__ROOT__</code>、<code>__PUBLIC_</code>_的值都是错误的，cgi.fix_pathinfo设为1时，虽然是正确的，但是这个设置会导致php出现安全漏洞。解决问题的方法就是1、开发中不使用tp框架的<code>__APP__</code>、<code>__ROOT__</code>、<code>__PUBLIC__</code>这几个常量，或者是自己在重新定义这几个常量。最后一步就是隐藏index.php，当然，如果是<code>http://local.api.com/abc/index.php/Apistore/Test/test</code>这种url，就没必要去隐藏了，类似<code>http://local.api.com/index.php/Apistore/Test/test</code>这种，就可以直接用<code>http://local.api.com/Apistore/Test/test</code>访问。</p>



<pre class="prettyprint hljs-dark"><code class="language-nginx hljs"><span class="hljs-attribute">location</span> / {<br><span class="hljs-attribute">root</span> /mnt/share/www/backend/branches/dev;<br><span class="hljs-attribute">index</span> index.html index.htm;<br><span class="hljs-attribute">if</span> (!-e <span class="hljs-variable">$request_filename</span>){<br><span class="hljs-comment">#地址作为将参数rewrite到index.php上。</span><br><span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)$</span> /index.php/<span class="hljs-variable">$1</span> <span class="hljs-literal">last</span>;<br>break;<br>         }<br>}<br></code></pre></div></body></html>