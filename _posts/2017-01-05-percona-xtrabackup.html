---
layout: article
title:  "percona xtrabackup"
tags: mysql 备份 xtrabackup
categories: 拓展
date: 2017-01-05 17:31:00
---
<div id='preview-contents' class='note-content'>
                        
                    



<h3 id="perconaxtrabackup"><code>percona</code>xtrabackup``</h3>

<p><code>percona xtrabackup</code>是<code>percona</code>公司打造的一款物理备份的可热备份的软件，xtra可以快速热备份MySQL数据，同时也可增量备份，<code>xtrabackup</code>跟mysqldump不一样的地方在于， dump是逻辑备份，将mysql数据用sql语句的形式备份下来，在数据量非常大的时候，不管是备份还是还原，速度都慢。并且在备份的时候，会锁表，阻塞写请求。而<code>xtrabackup</code>通过备份物理数据的方式，可以快速且热备份。 安装</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">pengzhen@pz:/usr/<span class="hljs-built_in">local</span>/src$ sudo wget https://www.percona.com/downloads/`xtrabackup`/Percona-`xtrabackup`-2.4.5/binary/debian/xenial/x86_64/percona-`xtrabackup`-24_2.4.5-1.xenial_amd64.deb<br>pengzhen@pz:/usr/<span class="hljs-built_in">local</span>/src$ sudo dpkg -i percona-`xtrabackup`-24_2.4.5-1.xenial_amd64.deb<br></code></pre>

<p><code>xtrabackup</code>所需权限较多，建议直接用<code>root</code>权限执行。较早之前的版本中<code>xtrabackup</code>命令只支持innodb引擎的备份,myisam需要用<code>innobackupex</code>命令来备份，但是自２.2版本后，<code>xtrabackup</code>可备份myisam引擎，但为了兼容，也可继续用<code>innobackupex</code>命令，只不过<code>innobackupex</code>是<code>xtrabackup</code>的一个软连接。</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">pengzhen@pz:/usr/<span class="hljs-built_in">local</span>$ ll /usr/bin/innobackupex<br>lrwxrwxrwx 1 root root 10 11月 25 18:27 /usr/bin/innobackupex -&gt; xtrabackup*<br></code></pre>

<p>备份部分数据</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">pengzhen@pz:/data/mysql$ xtrabackup --backup --host=127.0.0.1 --user=root --password=<span class="hljs-string">'qwer1111'</span> --target-dir=/data/mysql --databases=<span class="hljs-string">"test_1"</span><br>....<br>161223 23:13:14 Executing UNLOCK TABLES<br>161223 23:13:14 All tables unlocked<br>161223 23:13:14 [00] Copying ib_buffer_pool to /data/mysql/ib_buffer_pool<br>161223 23:13:14 [00] ...done<br>161223 23:13:14 Backup created <span class="hljs-keyword">in</span> directory <span class="hljs-string">'/data/mysql'</span><br>MySQL binlog position: filename <span class="hljs-string">'mysql_bin.000006'</span>, position <span class="hljs-string">'32824694'</span><br>161223 23:13:14 [00] Writing backup-my.cnf<br>161223 23:13:14 [00] ...done<br>161223 23:13:14 [00] Writing `xtrabackup`_info<br>161223 23:13:14 [00] ...done<br>`xtrabackup`: Transaction <span class="hljs-built_in">log</span> of lsn (93862990) to (93862999) was copied.<br><br>pengzhen@pz:/data/mysql$ ll<br>总用量 196668<br>drwxrwxr-x 4 pengzhen pengzhen 4096 12月 23 23:33 ./<br>drwxr-xr-x 4 pengzhen pengzhen 4096 12月 23 21:36 ../<br>-rw-r----- 1 pengzhen pengzhen 425 12月 23 23:13 backup-my.cnf<br>-rw-rw-r-- 1 pengzhen pengzhen 0 12月 23 23:33 drop<br>-rw-r----- 1 pengzhen pengzhen 300 12月 23 23:13 ib_buffer_pool<br>-rw-r----- 1 pengzhen pengzhen 79691776 12月 23 23:24 ibdata1<br>-rw-r----- 1 pengzhen pengzhen 50331648 12月 23 23:24 ib_logfile0<br>-rw-r----- 1 pengzhen pengzhen 50331648 12月 23 23:13 ib_logfile1<br>-rw-r----- 1 pengzhen pengzhen 12582912 12月 23 23:24 ibtmp1<br>drwxr-x--- 2 pengzhen pengzhen 4096 12月 23 23:24 test_1/<br>-rw-r----- 1 pengzhen pengzhen 26 12月 23 23:13 xtrabackup_binlog_info<br>-rw-rw-r-- 1 pengzhen pengzhen 26 12月 23 23:24 xtrabackup_binlog_pos_innodb<br>-rw-r----- 1 pengzhen pengzhen 115 12月 23 23:24 xtrabackup_checkpoints<br>-rw-r----- 1 pengzhen pengzhen 533 12月 23 23:13 xtrabackup_info<br>-rw-r----- 1 pengzhen pengzhen 8388608 12月 2<br></code></pre>

<p>当然，<code>xtrbackup</code>也可支持部分备份，包括部分表、部分库。网上关于整个实例备份资料较多，下面我就只尝试备份部分数据。 <br>
<code>xtrabackup_binlog_info</code>、<code>xtrabackup_checkpoints</code>、<code>xtrabackup_info</code>三个文件记录了一些相关的信息，可以通过cat等命令查看。然后就是还原数据，在还原数据前，我们先删除test_1库中的表，看数据是否还原了</p>

<pre class="prettyprint hljs-dark"><code class="language-sql hljs">mysql&gt; <span class="hljs-keyword">use</span> test_1;<br>Database changed<br>mysql&gt; <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> lms_store <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> test.lms_store;<br>Query OK, 53 rows affected (0.03 sec)<br>Records: 53 Duplicates: 0 Warnings: 0<br><br>mysql&gt; <span class="hljs-keyword">use</span> test_1;<br>Database changed<br>mysql&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">status</span>;<br>+<span class="hljs-comment">---------------+--------+---------+------------+--------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-------------------+----------+----------------+---------+</span><br>| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time | Update_time | Check_time | Collation | <span class="hljs-keyword">Checksum</span> | Create_options | <span class="hljs-keyword">Comment</span> |<br>+<span class="hljs-comment">---------------+--------+---------+------------+--------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-------------------+----------+----------------+---------+</span><br>| lms_score_log | <span class="hljs-keyword">InnoDB</span> | <span class="hljs-number">10</span> | Dynamic | <span class="hljs-number">155772</span> | <span class="hljs-number">77</span> | <span class="hljs-number">12075008</span> | <span class="hljs-number">0</span> | <span class="hljs-number">0</span> | <span class="hljs-number">4194304</span> | <span class="hljs-literal">NULL</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span> <span class="hljs-number">23</span>:<span class="hljs-number">09</span>:<span class="hljs-number">56</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span> <span class="hljs-number">23</span>:<span class="hljs-number">09</span>:<span class="hljs-number">58</span> | <span class="hljs-literal">NULL</span> | latin1_swedish_ci | <span class="hljs-literal">NULL</span> | | |<br>| lms_store | MyISAM | <span class="hljs-number">10</span> | Dynamic | <span class="hljs-number">53</span> | <span class="hljs-number">132</span> | <span class="hljs-number">7044</span> | <span class="hljs-number">281474976710655</span> | <span class="hljs-number">1024</span> | <span class="hljs-number">0</span> | <span class="hljs-literal">NULL</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span> <span class="hljs-number">23</span>:<span class="hljs-number">11</span>:<span class="hljs-number">41</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span> <span class="hljs-number">23</span>:<span class="hljs-number">11</span>:<span class="hljs-number">41</span> | <span class="hljs-literal">NULL</span> | latin1_swedish_ci | <span class="hljs-literal">NULL</span> | | |<br>+<span class="hljs-comment">---------------+--------+---------+------------+--------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-------------------+----------+----------------+---------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql&gt; <span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> lms_score_log;<br>Query OK, 1 rows affected (0.04 sec)<br>mysql&gt; <span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> lms_store;<br>Query OK, 1 rows affected (0.04 sec)<br>mysql&gt;<br></code></pre>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">pengzhen@pz:/data/mysql$ xtrabackup --prepare --target-dir=/data/mysql --export<br>pengzhen@pz:/data/mysql$ ll test_1<br>总用量 19528<br>drwxr-x--- 2 pengzhen pengzhen 4096 12月 23 23:24 ./<br>drwxrwxr-x 4 pengzhen pengzhen 4096 12月 23 23:24 ../<br>-rw-r----- 1 pengzhen pengzhen 65 12月 23 23:13 db.opt<br>-rw-rw-r-- 1 pengzhen pengzhen 800 12月 23 23:24 lms_score_log.cfg<br>-rw-r----- 1 pengzhen pengzhen 16384 12月 23 23:24 lms_score_log.exp<br>-rw-r----- 1 pengzhen pengzhen 8920 12月 23 23:13 lms_score_log.frm<br>-rw-r----- 1 pengzhen pengzhen 19922944 12月 23 23:13 lms_score_log.ibd<br>-rw-r----- 1 pengzhen pengzhen 13425 12月 23 23:13 lms_store.frm<br>-rw-r----- 1 pengzhen pengzhen 7044 12月 23 23:13 lms_store.MYD<br>-rw-r----- 1 pengzhen pengzhen 1024 12月 23 23:13 lms_store.MYI<br></code></pre>

<pre class="prettyprint hljs-dark"><code class="language-sql hljs">mysql&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`lms_store`</span> (<br>  -&gt; <span class="hljs-string">`store_id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br>  -&gt; <span class="hljs-string">`store_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'商家名称'</span>,<br>  -&gt; <span class="hljs-string">`logo`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'商店logo'</span>,<br>  -&gt; PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`store_id`</span>)<br>  -&gt; ) <span class="hljs-keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="hljs-number">57</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 ROW_FORMAT=DYNAMIC;<br>Query OK, 0 rows affected (0.00 sec)<br>  -&gt; `score_id` int(11) unsigned NOT NULL AUTO_INCREMENT <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'自增id'</span>,<br>  -&gt; <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户ID'</span>,<br>  -&gt; <span class="hljs-string">`type`</span> <span class="hljs-built_in">smallint</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'积分类型'</span>,<br>  -&gt; <span class="hljs-string">`desc`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">125</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'积分说明'</span>,<br>  -&gt; ) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">169447</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">'积分表'</span> ;<br>Query OK, 0 rows affected (0.03 sec)<br><br>mysql&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> lms_score_log DISCARD <span class="hljs-keyword">TABLESPACE</span>;<br>Query OK, 0 rows affected (0.01 sec)<br>mysql&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> lms_store DISCARD <span class="hljs-keyword">TABLESPACE</span>;<br>ERROR 1031 (HY000): Table storage engine for 'lms_store' doesn't have this option<br>mysql&gt;<br></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs">pengzhen@pz:/data/mysql$ sudo cp -R test_1/* /usr/<span class="hljs-built_in">local</span>/mysql/data/test_1/<br>pengzhen@pz:/data/mysql$ sudo chown -R mysql:mysql /usr/<span class="hljs-built_in">local</span>/mysql/data/test_1/<br></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-sql hljs">mysql&gt; <span class="hljs-keyword">use</span> test_1;<br>Database changed<br>mysql&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> lms_score_log <span class="hljs-keyword">import</span> <span class="hljs-keyword">TABLESPACE</span>;<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">status</span>;<br>+<span class="hljs-comment">---------------+--------+---------+------------+--------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-------------------+----------+----------------+---------+</span><br>| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time | Update_time | Check_time | Collation | <span class="hljs-keyword">Checksum</span> | Create_options | <span class="hljs-keyword">Comment</span> |<br>+<span class="hljs-comment">---------------+--------+---------+------------+--------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-------------------+----------+----------------+---------+</span><br>| lms_score_log | <span class="hljs-keyword">InnoDB</span> | <span class="hljs-number">10</span> | Dynamic | <span class="hljs-number">156261</span> | <span class="hljs-number">77</span> | <span class="hljs-number">12075008</span> | <span class="hljs-number">0</span> | <span class="hljs-number">0</span> | <span class="hljs-number">0</span> | <span class="hljs-literal">NULL</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-24</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">09</span> | <span class="hljs-literal">NULL</span> | <span class="hljs-literal">NULL</span> | latin1_swedish_ci | <span class="hljs-literal">NULL</span> | | |<br>| lms_store | MyISAM | <span class="hljs-number">10</span> | Dynamic | <span class="hljs-number">53</span> | <span class="hljs-number">132</span> | <span class="hljs-number">7044</span> | <span class="hljs-number">281474976710655</span> | <span class="hljs-number">1024</span> | <span class="hljs-number">0</span> | <span class="hljs-literal">NULL</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span> <span class="hljs-number">23</span>:<span class="hljs-number">11</span>:<span class="hljs-number">41</span> | <span class="hljs-number">2016</span><span class="hljs-number">-12</span><span class="hljs-number">-24</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">05</span> | <span class="hljs-literal">NULL</span> | latin1_swedish_ci | <span class="hljs-literal">NULL</span> | | |<br>+<span class="hljs-comment">---------------+--------+---------+------------+--------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-------------------+----------+----------------+---------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)<br></code></pre>

<p>可以看到，数据长度都是一样的，注意这里显示<code>innodb</code>的行数跟实际数据行数是不一致的。 可以看到部分备份数据比较麻烦，还是尽量整个备份吧。更详细的文档查看 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/" target="_blank">percona官网</a>，相关文档 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/partial_backups.html" target="_blank">xtrabackup部分备份</a>、<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/restoring_individual_tables.html" target="_blank">xtrabackup部分还原</a>、<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/backup_scenarios/full_backup.html" target="_blank">xtrabackup全部备份及还原</a>、<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/backup_scenarios/incremental_backup.html" target="_blank">xtrabackup增量备份</a>、<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html" target="_blank">xtrabackup选项</a>、<a href="http://dev.mysql.com/doc/refman/5.7/en/tablespace-copying.html" target="_blank">mysql innodb tablespace</a></p></div></body></html>